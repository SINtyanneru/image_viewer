<!DOCTYPE html>
<HTML>
	<HEAD>
		<TITLE>ビュワー</TITLE>

		<STYLE>
			:root{
				--SIDE_HEADER_WIDTH: 200px;
			}

			body{
				margin: 0px;
			}

			.ALL_IMAGE{
				position: absolute;
				top: 0px;
				left: 0px;

				width: var(--SIDE_HEADER_WIDTH);
				height: 100vh;

				overflow: scroll;

				border-right: solid 1px;
			}

			.ALL_IMAGE > .THMB_ITEM{
				text-align: center;
			}

			.ALL_IMAGE > .THMB_ITEM[select=true]{
				background-color: aqua;
			}

			.MAIN{
				position: absolute;
				top: 0px;
				left: var(--SIDE_HEADER_WIDTH);

				width: calc(100vw - var(--SIDE_HEADER_WIDTH) - 1px);
				height: 100vh;

				overflow: hidden;
				
				background-color: black;

				text-align: center;
			}

			.MAIN > .PAGE_NUM{
				position: fixed;
				top: 0px;
				right: 0px;

				width: fit-content;
				height: fit-content;

				color: white;
				background-color: rgba(0, 0, 0, 0.5);

				font-size: 30px;

				margin: 10px;
			}

			.MAIN > canvas{
				width: 100%;
				height: 100%;
			}

			.LOADING{
				position: fixed;
				top: 0px;
				left: 0px;

				width: 100vw;
				height: 100vh;

				background-color: rgba(0, 0, 0, 0.5);

				text-align: center;
			}

			.LOADING > .TEXT{
				font-size: 50px;
				color: white;
			}

			.LOADING > .LOG{
				width: calc(100% - 100px);
				height: 500px;
			}

			.HELP {
				position: fixed;
				top: 0px;
				left: 0px;

				width: 100vw;
				height: 100vh;

				color: white;
				background-color: rgba(0, 0, 0, 0.9);

				text-align: center;
			}
		</STYLE>
	</HEAD>
	<BODY>
		<DIV CLASS="SIDE_HEADER" ID="SIDE_HEADER">
			<DIV CLASS="ALL_IMAGE" ID="ALL_IMAGE"></DIV>
		</DIV>
		<DIV CLASS="MAIN" ID="MAIN">
			<!--ページ番号-->
			<DIV CLASS="PAGE_NUM" ID="PAGE_NUM"></DIV>

			<!--画像本体-->
			<CANVAS ID="VIEWER"></CANVAS>
		</DIV>

		<!--ロード画面-->
		<DIV CLASS="LOADING" ID="LOADING">
			<DIV CLASS="TEXT">
				読み込んでいます。。。
			</DIV>
		</DIV>

		<!--ヘルプ-->
		<DIV CLASS="HELP" ID="HELP" STYLE="display: none;">
			<H1>ヘルプ</H1>
			<HR>
			<TABLE>
				<TR>
					<TD>[←]</TD>
					<TD>ページを戻る</TD>
				</TR>
				<TR>
					<TD>[↑]</TD>
					<TD>ページを戻る</TD>
				</TR>
				<TR>
					<TD>[→]</TD>
					<TD>ページを進む</TD>
				</TR>
				<TR>
					<TD>[↓]</TD>
					<TD>ページを進む</TD>
				</TR>
				<TR>
					<TD>[Home]</TD>
					<TD>1ページ目へ飛ぶ</TD>
				</TR>
				<TR>
					<TD>[End]</TD>
					<TD>最終ページへ飛ぶ</TD>
				</TR>
				<TR>
					<TD>[Ctrl] + [/(?)]</TD>
					<TD>ヘルプを開く(もう一度押すと閉じます)</TD>
				</TR>
				<TR>
					<TD>[Esc]</TD>
					<TD>拡大率/位置をリセットします</TD>
				</TR>
			</TABLE>
		</DIV>
	</BODY>
</HTML>
<SCRIPT>
	const BASE_PATH = "/view";
	const IMG_PATH = window.location.pathname.replace(BASE_PATH, "");

	let IMAGE_LENGTH = 0;
	let IMAGE_THUMBNAIL_LIST = null;
	let IMAGE_LIST = {};
	let IMAGE_INDEX = 0;
	let ZOOM_LEVEL = 0;
	let POS = {X:0, Y:0};
	let TEMP = {};
	let EL = {
		ALL_IMAGE: document.getElementById("ALL_IMAGE"),
		MAIN: document.getElementById("MAIN"),
		VIEWER: document.getElementById("VIEWER"),
		CTX: document.getElementById("VIEWER").getContext("2d"),
		PAGE_NUM: document.getElementById("PAGE_NUM"),
		HELP: document.getElementById("HELP"),
		LOADING: {
			PARENT: document.getElementById("LOADING"),
		}
	}

	window.addEventListener("resize", (E) =>{
		DRAW_IMAGE();
	});

	window.addEventListener("load", async (E) => {
		//キャッシュの準備を開始する
		await DONE_CACHE(IMG_PATH);

		IMAGE_THUMBNAIL_LIST = await GET_IMAGE_LIST(IMG_PATH);

		IMAGE_LENGTH = IMAGE_THUMBNAIL_LIST.LIST.length;

		//サムネを表示
		for (let I = 0; I < IMAGE_THUMBNAIL_LIST.LIST.length; I++) {
			const IMAGE = IMAGE_THUMBNAIL_LIST.LIST[I];

			EL.ALL_IMAGE.innerHTML += `
				<DIV CLASS="THMB_ITEM" ID="THMB_ITEM-${I}" onclick="JUMP_PAGE(${I})">
					<IMG SRC="/API/GetThumbnail?PATH=${IMG_PATH}&I=${I}">
					<DIV>
						${IMAGE.NAME}
					</DIV>
				</DIV>
			`;
		}

		//画像を読み込み
		await DRAW_IMAGE();

		//読み込み完了
		EL.LOADING.PARENT.style.display = "none";

		THUMB_HAILAIT(0);
	});


	window.addEventListener("keydown", (E) => {
		//ヘルプ
		if (E.key === "/" && E.ctrlKey) {
			if (EL.HELP.style.display === "block") {
				EL.HELP.style.display = "none";
			} else {
				EL.HELP.style.display = "block";
			}
		}

		//ヘルプを開いてるならここで止まる
		if (EL.HELP.style.display === "block") {
			return;
		}

		switch(E.key) {
			//最初の頁へ行く
			case "Home": {
				IMAGE_INDEX = 0;

				THUMB_HAILAIT(IMAGE_INDEX);
				break;
			}

			//最終ページへ行く
			case "End": {
				IMAGE_INDEX = IMAGE_LENGTH - 1;

				THUMB_HAILAIT(IMAGE_INDEX);
				break;
			}

			//ページを戻る
			case "ArrowUp":
			case "ArrowLeft": {
				if (IMAGE_INDEX >= 1) {
					IMAGE_INDEX--;

					//ページ番号を表示?
					EL.PAGE_NUM.innerText = `${IMAGE_LENGTH + 1}/${IMAGE_INDEX + 1}`;

					THUMB_HAILAIT(IMAGE_INDEX);
				} else {
					EL.PAGE_NUM.innerText = "1ページ";
				}
				break;
			}

			//ページを進む
			case "ArrowDown":
			case "ArrowRight": {
				if (IMAGE_INDEX <= IMAGE_LENGTH - 2) {
					IMAGE_INDEX++;

					//ページ番号を表示
					EL.PAGE_NUM.innerText = `${IMAGE_LENGTH + 1}/${IMAGE_INDEX + 1}`;

					THUMB_HAILAIT(IMAGE_INDEX);
				} else {
					EL.PAGE_NUM.innerText = "最終ページ";
				}
				break;
			}

			//拡大率/位置をリセット
			case "Escape": {
				POS.X = 0;
				POS.Y = 0;
				ZOOM_LEVEL = 0;

				DRAW_IMAGE();
				break;
			}
		}
	});

	window.addEventListener("keyup", async (E) => {
		switch(E.key) {
			case "Home":
			case "End":
			case "ArrowUp":
			case "ArrowDown":
			case "ArrowLeft":
			case "ArrowRight": {
				//ページ番号を消す
				EL.PAGE_NUM.innerText = "";

				//画像を読み込み
				DRAW_IMAGE();
				break;
			}
		}
	});


	//マウスホイール
	EL.VIEWER.addEventListener("wheel", (E) => {
		if (E.deltaY > 0) {
			//下に転がした
			if (ZOOM_LEVEL >= 1) {
				ZOOM_LEVEL--;

				DRAW_IMAGE();
			}
		} else {
			//上に転がした
			ZOOM_LEVEL++;

			DRAW_IMAGE();
		}
	})

	//マウスカーソルの真ん中
	EL.VIEWER.addEventListener("mousemove", (E) => {
		//真ん中のボタンでドラッグしているか
		if (E.buttons === 4) {
			//座標に移動量を足す
			POS.X += E.movementX;
			POS.Y += E.movementY;

			DRAW_IMAGE();
		}
	});

	function THUMB_HAILAIT(I) {
		let THUMB_EL = document.getElementById("THMB_ITEM-" + I);
		if (THUMB_EL != null) {
			//前に選択しているページ番号のキャッシュがNullじゃないなら
			if (TEMP["TH_HAI_OLD_INDEX"] != null) {
				let OLD_THUMB_EL = document.getElementById("THMB_ITEM-" + TEMP["TH_HAI_OLD_INDEX"]);
				if (OLD_THUMB_EL != null) {
					//前に選択していたページのサムネの属性をfalseにする
					OLD_THUMB_EL.setAttribute("select", false);
				}
			}

			//今選択しているサムネに属性を付ける
			THUMB_EL.setAttribute("select", true);

			//サムネの場所までスクロール
			THUMB_EL.scrollIntoView({
				behavior: "smooth"
			});


			//今選択しているページ番号をキャッシュに入れる
			TEMP["TH_HAI_OLD_INDEX"] = IMAGE_INDEX;
		}
	}

	function JUMP_PAGE(I) {
		IMAGE_INDEX = I;

		THUMB_HAILAIT(I);
		DRAW_IMAGE();
	}

	async function DRAW_IMAGE() {
		//CANVASのサイズを設定
		EL.VIEWER.width = EL.MAIN.clientWidth;
		EL.VIEWER.height = EL.MAIN.clientHeight;

		function DRAW(IMAGE) {
			const ZOOM = (ZOOM_LEVEL * (ZOOM_LEVEL * 100));
			const H = EL.VIEWER.height + ZOOM;		//高さ、「CANVASの高さ+ズームレベル」
			const W = (H / IMAGE.height) * IMAGE.width;			//横幅、「（高さ÷画像の高さ）×画像の横幅」
			const X = (EL.VIEWER.width - W) / 2 + POS.X;
			const Y = POS.Y;

			EL.CTX.drawImage(IMAGE, X, Y, W, H);
		}

		//今読み込んでる画像と、選択している画像が違うなら画像の再読込からする
		if (TEMP["IMAGE_INDEX_POS"] !== IMAGE_INDEX) {
			//画像を読み込んで表示
			const IMAGE = new Image();

			//読み込んだらImage型を渡す
			IMAGE.addEventListener("load", (E) =>{
				DRAW(IMAGE);

				//キャッシュを更新
				TEMP["IMAGE_DATA"] = IMAGE;
				TEMP["IMAGE_INDEX_POS"] = IMAGE_INDEX;
			});

			//読み込む
			IMAGE.src = await GET_IMAGE(IMG_PATH, IMAGE_INDEX);
		} else {
			DRAW(TEMP["IMAGE_DATA"]);
		}
	}

	async function DONE_CACHE(PATH) {
		let AJAX = await fetch("/API/Cache?PATH=" + PATH);
		const RESULT = await AJAX.json();

		if (RESULT.STATUS) {
			return true
		} else {
			return false;
		}
	}

	async function GET_IMAGE_LIST(PATH) {
		let AJAX = await fetch("/API/GetALL_IMAGE?PATH=" + PATH);
		const RESULT = await AJAX.json();

		if (RESULT.STATUS) {
			return {
				"NAME": RESULT.NAME,
				"LIST": RESULT.LIST
			}
		} else {
			return null;
		}
	}

	async function GET_IMAGE(PATH, I) {
		//キャッシュがあるか
		if (IMAGE_LIST[I] == null) {
			let AJAX = await fetch(`/API/GetImage?PATH=${PATH}&I=${I}`);

			if (AJAX.ok) {
				const ARRAY_BUFFER = await AJAX.arrayBuffer();
				const BYTE_ARRAY = new Uint8Array(ARRAY_BUFFER);
				const BINARY_STRING = BYTE_ARRAY.reduce((DATA, BYTE) => DATA + String.fromCharCode(BYTE), "");
				const Base64DATA = btoa(BINARY_STRING);

				//画像をキャッシュに
				IMAGE_LIST[I] = `data:${AJAX.headers.get("Content-Type")};base64,${Base64DATA}`;

				return IMAGE_LIST[I];
			} else {
				return null;
			}
		} else{
			return IMAGE_LIST[I];
		}
	}
</SCRIPT>